# ChemVantage AI Coding Guidelines

**Project**: Open Educational Resource for online General Chemistry education deployed on Google Cloud Platform (App Engine).

## Architecture Overview

ChemVantage is a **Spring Boot servlet-based application** (Java 21) using:
- **Spring Boot 3.1** as the web framework with embedded Tomcat
- **Objectify** (v6.1.3) as the ORM for Google Cloud Datastore (NoSQL)
- **LTI v1.3** integration for LMS platform connectivity
- **Jakarta Servlets** (not legacy javax) for request handling
- **Google Cloud Tasks** and **Cloud Datastore** for backend processing

The `@SpringBootApplication` entry point scans for `@WebServlet` annotated classes and auto-registers them. Static resources are served directly by App Engine infrastructure from `src/main/webapp/`.

## Key Data Model Patterns

**Entities** (see [ObjectifyWebListener.java](src/main/java/org/chemvantage/ObjectifyWebListener.java)):
- All data entities use `@Entity` annotation from Objectify and are registered on app startup
- IDs are typically `@Id Long` autogenerated; indexed fields use `@Index` annotation
- Core entities: `Question`, `Topic`, `Subject`, `Assignment`, `User`, `Deployment`, various `*Transaction` classes (QuizTransaction, HWTransaction, etc.)

**Transaction Pattern**: Every user interaction creates a `*Transaction` entity (e.g., `QuizTransaction`, `PracticeExamTransaction`) that records:
- User ID (stored as `Subject.hashId(userId)` for privacy in LTI contexts)
- Score and possible score
- Question keys and answer maps
- Timestamps for tracking (downloaded, graded)

**User Authentication**:
- LTI users: Authenticated via JWT tokens containing platformDeploymentId, platformUserId, and roles (0=Learner, 8=Instructor, 16=Administrator)
- Anonymous users: Session-based with 90-minute expiration; ID derived from expiration timestamp
- See [User.java](src/main/java/org/chemvantage/User.java) for ID hashing logic

## Query & Database Patterns

**Objectify Usage** (imported as `import static com.googlecode.objectify.ObjectifyService.ofy;`):
```java
// Retrieving: ofy().load().type(Entity.class).id(id).safe() or .now()
Question q = ofy().load().type(Question.class).id(qId).safe();

// Filtering: .filter(field, value) chains are common
List<Deployment> active = ofy().load().type(Deployment.class)
    .filter("status", "pending").list();

// Saving: ofy().save().entity(obj) or .entities(list)
ofy().save().entity(question);

// Deleting: ofy().delete().entity(obj)
```

**Key Conventions**:
- Use `.safe()` for required lookups (throws NotFoundException if missing)
- Use `.now()` for synchronous loads when result is needed immediately
- Indexed fields (`@Index Date exp`) enable filtering; add indexes to fields used in `.filter()` queries
- Response entities often stored with `Subject.hashId(userId)` to prevent PII exposure

## Servlet Routing & Request Handling

**WebServlet Pattern**:
- Every public-facing feature is a `@WebServlet("/endpoint")` extending `HttpServlet`
- Override `doGet()` for retrieval, `doPost()` for mutations
- Request params via `request.getParameter(name)`
- Response HTML written to `PrintWriter out = response.getWriter()`
- Security: Admin servlets protected by App Engine `login: admin` handler in [app.yaml](src/main/appengine/app.yaml)

**Security Utilities**: 
Use [AdminSecurityUtil.java](src/main/java/org/chemvantage/AdminSecurityUtil.java) for admin endpoint authentication:
```java
if (!AdminSecurityUtil.isAdminAuthenticated(request)) {
    AdminSecurityUtil.handleAuthenticationFailure(request, response, "/Edit");
}
```

## Common Workflows & Commands

**Local Development**:
```bash
# Build and run with embedded Tomcat (visits http://localhost:8080)
mvn clean package exec:java

# Deploy to Google Cloud App Engine
gcloud auth application-default login
gcloud config set project PROJECT_ID
mvn clean package appengine:deploy

# On cache issues (if not deployed >1 month):
gcloud app deploy --no-cache

# Datastore index management
gcloud --project chem-vantage-hrd datastore indexes create index.yaml
gcloud --project chem-vantage-hrd datastore indexes cleanup index.yaml
```

## File Organization

- **Servlets**: `src/main/java/org/chemvantage/*.java` (e.g., `Edit.java`, `Admin.java`, `LTIv1p3Launch.java`)
- **Entities**: Same package, annotated with `@Entity` (e.g., `Question.java`, `User.java`)
- **Web Assets**: `src/main/webapp/` (HTML, CSS, JS served statically via App Engine)
- **Configuration**: `src/main/appengine/app.yaml` defines routing, scaling, and static file handlers
- **Build Config**: `pom.xml` specifies Spring Boot 3.1, Java 21, and Maven plugins

## Integration Points & Special Handling

**LTI 1.3 Integration** ([LTIv1p3Launch.java](src/main/java/org/chemvantage/LTIv1p3Launch.java)):
- Each assignment requires a separate LTI launch; platformDeploymentId combines platform_id + deployment_id
- JWT tokens decode role masks: Learner (0), Instructor (8), Administrator (16)
- Resource link IDs map to Assignment entities; user_id combined with platform_id for uniqueness

**Email & External Services**:
- SendGrid for transactional email via `EmailMessage` entity
- Math expression parsing via `com.bestcode.mathparser.MathParserFactory`
- PDF generation with OpenPDF for reports/certificates

**Testing**: Test directory empty; focus on integration testing via manual deployment or GCP emulator.

## Common Pitfalls to Avoid

1. **Objectify Registration**: All `@Entity` classes must be registered in `ObjectifyWebListener.contextInitialized()` or datastore operations will fail
2. **User Privacy**: Always use `Subject.hashId(userId)` when storing user references in transactions; avoid plain text user IDs
3. **Servlet Import Errors**: Use `jakarta.servlet.*` (not legacy `javax.servlet.*`) since Spring Boot 3.1
4. **Static Resource Paths**: Referenced in `app.yaml` as `classes/META-INF/resources/...` (Maven builds to this structure)
5. **Datastore Schema**: Adding new fields to entities is safe (Objectify handles versioning); removing indexed fields requires index cleanup

## References

- Spring Boot 3.1: https://spring.io/projects/spring-boot
- Objectify ORM: https://github.com/objectify/objectify
- LTI 1.3 Spec: https://www.imsglobal.org/spec/lti/v1p3/
- Google App Engine Java: https://cloud.google.com/appengine/docs/standard/java-runtime
